<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="与其哀叹，不如埋头苦干"><title>Mochazz's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script></head><link rel="stylesheet" type="text/css" href="/css/customize.css"><link rel="stylesheet" type="text/css" href="/plugins/prettify/doxy.css"><script type="text/javascript" src="/js/ready.js" async></script><body><div class="mobile-head" id="mobile-head"><div class="navbar-icon"><span></span><span></span><span></span></div><div class="navbar-title"><a href="/"></a></div><div class="navbar-search"><!--= show a circle here--></div></div><div class="h-wrapper" id="menu"><nav class="h-head box"><div class="m-hdimg"><a class="hdimg img" href="/"><img class="nofancybox" src="/img/tx.jpeg" width="128" height="128"></a><h1 class="ttl"><a href="/">Mochazz's blog</a></h1></div><p class="m-desc">与其哀叹，不如埋头苦干</p><div class="m-nav"><ul><li><span class="dot">●</span><a href="/archives/">归档</a></li><li><span class="dot">●</span><a href="/about/">关于</a></li><span class="dot">●</span><span>友链</span><li><span class="dot">●</span><span class="dot">●</span><a href="http://www.lmxspace.com">l1nk3r</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="https://www.virzz.com">Virink</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://sec2hack.com">Wfox</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://www.lsafe.org">离心</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="https://www.kingkk.com">kingkk</a></li><li><span class="dot">●</span><span class="dot">●</span><a href="http://hpdoger.me">hpdoger</a></li></ul></div></nav></div><div id="back2Top"><a class="fa fa-arrow-up" title="Back to top" href="#"></a></div><div class="box" id="container"><div class="l-wrapper"><div class="l-content box"><div class="l-postlist"><div class="l-post"><div class="p-desc box"><div class="p-pic"></div><h1 class="p-title"><a href="/2018/12/11/python web之flask session&amp;格式化字符串漏洞/">Python Web之flask session&amp;格式化字符串漏洞</a></h1><div class="p-content"><p>这是在参加百越杯CTF遇到的一道题目，其中涉及到两个python安全相关的知识点，在此做一个总结。</p>
<h2 id="flask-session问题"><a href="#flask-session问题" class="headerlink" title="flask session问题"></a>flask session问题</h2><p>由于 <strong>flask</strong> 是非常轻量级的 <strong>Web框架</strong> ，其 <strong>session</strong> 存储在客户端中（可以通过HTTP请求头Cookie字段的session获取），且仅对 <strong>session</strong> 进行了签名，缺少数据防篡改实现，这便很容易存在安全漏洞。</p>
<p>假设现在我们有一串 <strong>session</strong> 值为： <strong>eyJ1c2VyX2lkIjo2fQ.XA3a4A.R-ReVnWT8pkpFqM_52MabkZYIkY</strong> ，那么我们可以通过如下代码对其进行解密：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> *</span><br><span class="line">s = <span class="string">"eyJ1c2VyX2lkIjo2fQ.XA3a4A.R-ReVnWT8pkpFqM_52MabkZYIkY"</span></span><br><span class="line">data,timestamp,secret = s.split(<span class="string">'.'</span>)</span><br><span class="line">int.from_bytes(base64_decode(timestamp),byteorder=<span class="string">'big'</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/1.png" alt="1"></p>
<p>还可以用如下 <a href="https://www.leavesongs.com" target="_blank" rel="noopener"><strong>P师傅</strong></a> 的程序解密：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> session_json_serializer</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decryption</span><span class="params">(payload)</span>:</span></span><br><span class="line">    payload, sig = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line">    payload, timestamp = payload.rsplit(<span class="string">b'.'</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    decompress = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> payload.startswith(<span class="string">b'.'</span>):</span><br><span class="line">        payload = payload[<span class="number">1</span>:]</span><br><span class="line">        decompress = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        payload = base64_decode(payload)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">'Could not base64 decode the payload because of '</span></span><br><span class="line">                         <span class="string">'an exception'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> decompress:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = zlib.decompress(payload)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">'Could not zlib decompress the payload before '</span></span><br><span class="line">                             <span class="string">'decoding the payload'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> session_json_serializer.loads(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    print(decryption(sys.argv[<span class="number">1</span>].encode()))</span><br></pre></td></tr></table></figure>
<p>通过上述脚本解密处 <strong>session</strong> ，我们就可以大概知道 <strong>session</strong> 中存储着哪些基本信息。然后我们可以通过其他漏洞获取用于签名认证的 <strong>secret_key</strong> ，进而伪造任意用户身份，扩大攻击效果。</p>
<p>关于 <strong>flask</strong> 的 <strong>session</strong> 机制，可以参考这篇文章：<a href="http://cizixs.com/2017/03/08/flask-insight-session/" target="_blank" rel="noopener">flask 源码解析：session</a> </p>
<p>关于客户端 <strong>session</strong> 问题，可以参考这篇文章：<a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank" rel="noopener">客户端 session 导致的安全问题</a> </p>
<h2 id="Python格式化字符串问题"><a href="#Python格式化字符串问题" class="headerlink" title="Python格式化字符串问题"></a>Python格式化字符串问题</h2><p>在 <strong>python</strong> 中，提供了 <strong>4种</strong> 主要的格式化字符串方式，分别如下：</p>
<p><strong>第一种：%操作符</strong> </p>
<p><strong>%操作符</strong> 沿袭C语言中printf语句的风格。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>name = <span class="string">'Bob'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'Hello, %s'</span> % name</span><br><span class="line"><span class="string">"Hello, Bob"</span></span><br></pre></td></tr></table></figure>
<p><strong>第二种：string.Template</strong> </p>
<p>使用标准库中的模板字符串类进行字符串格式化。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; name = <span class="string">'Bob'</span></span><br><span class="line">&gt;&gt;&gt; from string import Template</span><br><span class="line">&gt;&gt;&gt; t = Template(<span class="string">'Hey, $name!'</span>)</span><br><span class="line">&gt;&gt;&gt; t.substitute(name=name)</span><br><span class="line"><span class="string">'Hey, Bob!'</span></span><br></pre></td></tr></table></figure>
<p><strong>第三种：调用format方法</strong> </p>
<p>python3后引入的新版格式化字符串写法，但是这种写法存在安全隐患。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; name , errno = <span class="string">'Bob'</span> , 50159747054</span><br><span class="line">&gt;&gt;&gt; <span class="string">'Hello, &#123;&#125;'</span>.format(name)</span><br><span class="line"><span class="string">'Hello, Bob'</span></span><br><span class="line">&gt;&gt;&gt; <span class="string">'Hey &#123;name&#125;, there is a 0x&#123;errno:x&#125; error!'</span>.format(name=name, errno=errno)</span><br><span class="line"><span class="string">'Hey Bob, there is a 0xbadc0ffee error!'</span></span><br></pre></td></tr></table></figure>
<p>存在安全隐患的事例代码：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; config = &#123;<span class="string">'SECRET_KEY'</span>: <span class="string">'12345'</span>&#125;</span><br><span class="line">&gt;&gt;&gt; class User(object):</span><br><span class="line">...  def __init__(self, name):</span><br><span class="line">...   self.name = name</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; user = User(<span class="string">'joe'</span>)</span><br><span class="line">&gt;&gt;&gt; <span class="string">'&#123;0.__class__.__init__.__globals__[config]&#125;'</span>.format(user)</span><br><span class="line"><span class="string">"&#123;'SECRET_KEY': '12345'&#125;"</span></span><br></pre></td></tr></table></figure>
<p>从上面的例子中，我们可以发现：如果用来格式化的字符串可以被控制，攻击者就可以通过注入特殊变量，带出敏感数据。更多漏洞分析，可以参阅：<a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html" target="_blank" rel="noopener">Python 格式化字符串漏洞（Django为例）</a> </p>
<p><strong>第四种:f-Strings</strong> </p>
<p>这是python3.6之后新增的一种格式化字符串方式，其功能十分强大，可以执行字符串中包含的python表达式，安全隐患可想而知。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; a , b = 5 , 10</span><br><span class="line">&gt;&gt;&gt; f<span class="string">'Five plus ten is &#123;a + b&#125; and not &#123;2 * (a + b)&#125;.'</span></span><br><span class="line"><span class="string">'Five plus ten is 15 and not 30.'</span></span><br><span class="line">&gt;&gt;&gt; f<span class="string">'&#123;__import__("os").system("id")&#125;'</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line"><span class="string">'0'</span></span><br></pre></td></tr></table></figure>
<p>关于这4种格式化字符串方式的更多内容，可以参阅：<a href="https://realpython.com/python-string-formatting/#which-string-formatting-method-should-you-use" target="_blank" rel="noopener">Python String Formatting Best Practices</a>  </p>
<h2 id="案例分析"><a href="#案例分析" class="headerlink" title="案例分析"></a>案例分析</h2><p>题目界面如下：</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/2.png" alt="2"></p>
<p>这是 <strong>flask</strong> 写的一个网站，网站提供了注册和登录功能。在用户登录后，存在一个 <strong>edit secert</strong> 功能，下面我们直接来审计源码。</p>
<p>需要阅读的代码文件就4个，代码量相对较少。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/3.png" alt="3"></p>
<p><code>__init__.py</code> 的代码主要对Web应用程序进行初始化操作。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/4.png" alt="4"></p>
<p><code>auth.py</code> 的代码主要是对用户的身份进行处理</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/5.png" alt="5"></p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/6.png" alt="6"></p>
<p>可以看到 <strong>第84-91行</strong> 代码，只有 <strong>admin</strong> 身份才能获得 <strong>flag</strong> ，而 <strong>第73行</strong> 代码会将成功登录的用户重定向到用户基本信息查看页面，链接形式形如：<strong><a href="http://xxxxx/views?id=6" target="_blank" rel="noopener">http://xxxxx/views?id=6</a></strong> 。我们可以对这里的id进行遍历，查看是否存在用户信息遍历漏洞，事实证明是存在的。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/7.png" alt="7"></p>
<p><code>db_init.py</code> 的代码主要就是定义了数据库的表模型，这里便不再贴代码。</p>
<p><code>secert.py</code> 的代码需要关注一下，其中对查看用户信息和编辑secret做了定义。当我们在阅读 <strong>views_info</strong> 方法的代码时，就知道上面的用户信息遍历漏洞是如何形成的了。首先只要用户登录了，页面就会根据 <strong>id</strong> 将对应的用户信息显示在页面上，而这个 <strong>id</strong> 可以通过 <strong>GET</strong> 请求方式来控制，这就形成了用户信息遍历漏洞。但是要想读取其他用户的 <strong>secert</strong> ， <strong>id</strong> 值就必须和 <strong>session</strong> 中存储的 <strong>user_id</strong> 值一样。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/9.png" alt="9"></p>
<p>观察上图 <strong>第26、33行</strong> ，很明显的看到 <strong>secert_t</strong> 变量进行了两次格式化，这里便存在格式化字符串漏洞。例如我们试一下编辑 <strong>secret</strong> 值为：<code>{user_m.password}</code> ，发现确实可以带出数据。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/10.png" alt="10"></p>
<p>继续往下看 <strong>edit_secert</strong> 方法，其主要是定义了用户只能修改自己的 <strong>scert</strong> ，没有需要关注的地方。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/11.png" alt="11"></p>
<p>那么现在的思路就是通过这个格式化字符串漏洞，带出 <strong>flask</strong> 用于签名认证的 <strong>SECRET_KEY</strong> ，然后本地运行网站代码，通过该 <strong>SECRET_KEY</strong> 伪造 <strong>admin</strong> 的 <strong>session</strong> 登录即可。由于可注入的对象 <strong>user_m</strong> 是继承自 <strong>SQLAlchemy</strong> 对象，我们在查阅其源码时发现在开头处导入了 <strong>current_app</strong> 对象。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/13.png" alt="13"></p>
<p>我们通过注入下面 <strong>payload</strong> ，可以查看到 <strong>Web</strong> 应用程序使用的 <strong>SECRET_KEY</strong> 。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;user_m.__class__.__base__.__class__.__init__.__globals__[current_app].config&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/14.png" alt="14"></p>
<p>PS：这里也附上官方 <strong>writeup</strong> 中的 <strong>payload</strong> ：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;user_m.__class__.__mro__[1].__class__.__mro__[0].__init__.__globals__[SQLAlchemy].__init__.__globals__[current_app].config&#125;</span><br></pre></td></tr></table></figure>
<p>在获取了 <strong>SECRET_KEY</strong> 后，我们就来伪造 <strong>admin</strong> 的 <strong>session</strong> 登录看看。前面我们说过了， <strong>flask</strong> 的 <strong>session</strong> 是存储在 <strong>cookie</strong> 中的，所以我们先来看一下本例中普通用户的 <strong>session</strong> 形式。</p>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/15.png" alt="15"></p>
<p>我们在前面的用户信息遍历漏洞中，可知 <strong>admin</strong> 的 <strong>id</strong> 为5，所以我们本地跑起 <strong>flask</strong> 程序，用得到的 <strong>SECRET_KEY</strong> 伪造 <strong>admin</strong> 的 <strong>session</strong> 。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># test_app.py</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>]=<span class="string">'ichunqiuQAQ013'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/flag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_id</span><span class="params">()</span>:</span></span><br><span class="line">    session[<span class="string">'user_id'</span>]=<span class="number">5</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok"</span></span><br><span class="line"></span><br><span class="line">app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/img/python web之flask session&amp;格式化字符串漏洞/16.png" alt="16"></p>
<p>PS：起 <strong>flask</strong> 的时候，用命令 <strong>flask init-db</strong> 初始化数据库的时候，遇到 <strong>Error: No such command “init-db”</strong> 错误，后面通过 <code>export FLASK_APP=__init__.py</code> 解决。</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="http://cizixs.com/2017/03/08/flask-insight-session/" target="_blank" rel="noopener">http://cizixs.com/2017/03/08/flask-insight-session/</a><br><a href="https://www.leavesongs.com/PENETRATION/client-session-security.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/client-session-security.html</a><br><a href="https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/python-string-format-vulnerability.html</a><br><a href="http://lucumr.pocoo.org/2016/12/29/careful-with-str-format/" target="_blank" rel="noopener">http://lucumr.pocoo.org/2016/12/29/careful-with-str-format/</a><br><a href="https://realpython.com/python-string-formatting/" target="_blank" rel="noopener">https://realpython.com/python-string-formatting/</a><br><a href="https://bbs.ichunqiu.com/thread-48533-1-1.html" target="_blank" rel="noopener">第四届“百越杯”福建省高校网络空间安全大赛官方writeup</a> </p>
</div><!--p(class='p-readmore')//a(href=url_for(post.path))= __('阅读更多 >>')
--></div><div class="p-info box"><span class="p-date"><i class="fa fa-calendar"></i><a href="/2018/12/11/python web之flask session&amp;格式化字符串漏洞/">2018-12-11</a></span><span class="p-category"><i class="fa fa-folder"></i><a href="/categories/CTF竞赛训练/">CTF竞赛训练</a></span><span class="p-tags"><i class="fa fa-tag"></i><a href="/tags/CTF/">CTF</a></span></div></div></div><div class="l-pager l-pager-id box" id="page-nav"><a class="extend prev" rel="prev" href="/page/13/">&lt;上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/124/">124</a><a class="extend next" rel="next" href="/page/15/">下一页&gt;</a></div><footer><p>Copyright © 2017 - 2019 <a href="/." rel="nofollow">Mochazz's blog</a> | <strong><a rel="nofollow" target="_blank" href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a></strong><br><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span></span> <span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span></span> | Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a>Theme with<a rel="nofollow" target="_blank" href="https://github.com/litreily/snark-hexo"> snark.</a></p></footer></div></div></div><script type="text/javascript" src="/plugins/prettify/prettify.js"></script><script type="text/javascript" src="/js/search.js"></script><script type="text/javascript" src="/js/top.js"></script><script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"></body></html>